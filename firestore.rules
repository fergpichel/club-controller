rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ──────────────────────────────────────────────
    // HELPERS
    // ──────────────────────────────────────────────

    function isAuth() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function appConfig() {
      return get(/databases/$(database)/documents/config/app).data;
    }

    function isRegistrationOpen() {
      return appConfig().registrationOpen == true;
    }

    function belongsToClub(clubId) {
      return isAuth() && userDoc().clubId == clubId;
    }

    function userRole(clubId) {
      return belongsToClub(clubId) ? userDoc().role : 'none';
    }

    function isAdminOrManager(clubId) {
      return userRole(clubId) in ['admin', 'manager'];
    }

    function canWrite(clubId) {
      return userRole(clubId) in ['admin', 'manager', 'controller', 'editor'];
    }

    function canApprove(clubId) {
      return userRole(clubId) in ['admin', 'manager', 'controller'];
    }

    // ──────────────────────────────────────────────
    // USERS
    // ──────────────────────────────────────────────
    match /users/{userId} {
      // Any authenticated user can read members of their own club.
      // Users can always read their own document.
      allow read: if isAuth()
        && (uid() == userId || userDoc().clubId == resource.data.clubId);

      // User can create their own document during registration
      // Only allowed if registration is open OR user has a clubId (coming from invitation)
      allow create: if isAuth() && uid() == userId
        && (isRegistrationOpen() || request.resource.data.clubId != '');

      // Users can update their own profile BUT cannot change role or clubId
      allow update: if isAuth() && uid() == userId
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clubId']);

      // Admin/manager can update any member in their club (e.g. change role)
      allow update: if isAuth()
        && isAdminOrManager(resource.data.clubId);

      // Only admin can delete a member
      allow delete: if isAuth()
        && userRole(resource.data.clubId) == 'admin';
    }

    // ──────────────────────────────────────────────
    // CLUBS
    // ──────────────────────────────────────────────
    match /clubs/{clubId} {
      allow read: if isAuth() && belongsToClub(clubId);

      // Only allowed when registration is open (creating a new club)
      allow create: if isAuth() && isRegistrationOpen();

      // Only admin/manager can update club settings
      allow update: if isAdminOrManager(clubId);

      allow delete: if false; // Clubs cannot be deleted from client

      // AI CORRECTIONS (feedback for categorization)
      match /ai_corrections/{correctionId} {
        allow read: if isAuth() && belongsToClub(clubId);
        allow create: if isAuth() && belongsToClub(clubId);
        allow update, delete: if false; // Corrections are append-only
      }
    }

    // ──────────────────────────────────────────────
    // TRANSACTIONS
    // ──────────────────────────────────────────────
    match /transactions/{txId} {
      // All club members can read (employee filtering is done client-side for their own)
      // Firestore rules cannot filter "only your own" per query, but the employee
      // client code already filters by createdBy. The data is not truly secret
      // between club members — the RBAC layer hides it in the UI.
      allow read: if isAuth() && belongsToClub(resource.data.clubId);

      // Any club member with edit permission can create
      allow create: if isAuth()
        && belongsToClub(request.resource.data.clubId)
        && request.resource.data.createdBy == uid()
        && userRole(request.resource.data.clubId) in ['admin', 'manager', 'controller', 'editor', 'employee'];

      // Editors+ can update; employees can only update their own pending transactions
      allow update: if isAuth()
        && belongsToClub(resource.data.clubId)
        && (
          canWrite(resource.data.clubId)
          || (userRole(resource.data.clubId) == 'employee' && resource.data.createdBy == uid() && resource.data.status == 'pending')
        );

      // Only admin/manager can delete transactions
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // CATEGORIES
    // ──────────────────────────────────────────────
    match /categories/{catId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // TEAMS
    // ──────────────────────────────────────────────
    match /teams/{teamId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // PROJECTS
    // ──────────────────────────────────────────────
    match /projects/{projectId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // EVENTS
    // ──────────────────────────────────────────────
    match /events/{eventId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // BUDGETS
    // ──────────────────────────────────────────────
    match /budgets/{budgetId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // FORECASTS
    // ──────────────────────────────────────────────
    match /forecasts/{forecastId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // MONTH CLOSINGS
    // ──────────────────────────────────────────────
    match /monthClosings/{closingId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);

      // Only admin and controller can close months
      allow create: if isAuth()
        && belongsToClub(request.resource.data.clubId)
        && userRole(request.resource.data.clubId) in ['admin', 'controller'];

      allow update: if isAuth()
        && belongsToClub(resource.data.clubId)
        && userRole(resource.data.clubId) in ['admin', 'controller'];

      allow delete: if false; // Closings cannot be deleted
    }

    // ──────────────────────────────────────────────
    // INVITATIONS
    // ──────────────────────────────────────────────
    match /invitations/{invId} {
      // Public read needed so unauthenticated users can verify invitations during registration.
      // Security is ensured by the cryptographic invitationToken check in app code.
      allow read: if true;

      // Only admin/manager of the club can create invitations
      allow create: if isAuth()
        && isAdminOrManager(request.resource.data.clubId);

      // Anyone authenticated can update (to accept their own invitation)
      allow update: if isAuth()
        && (resource.data.email == request.auth.token.email
            || isAdminOrManager(resource.data.clubId));

      // Only admin/manager can delete invitations
      allow delete: if isAuth()
        && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // CATALOGS (age categories, gender options)
    // ──────────────────────────────────────────────
    match /ageCategories/{docId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow write: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    match /genderOptions/{docId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow write: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // SUPPLIERS
    // ──────────────────────────────────────────────
    match /suppliers/{docId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // SPONSORS
    // ──────────────────────────────────────────────
    match /sponsors/{docId} {
      allow read: if isAuth() && belongsToClub(resource.data.clubId);
      allow create: if isAuth() && isAdminOrManager(request.resource.data.clubId);
      allow update: if isAuth() && isAdminOrManager(resource.data.clubId);
      allow delete: if isAuth() && isAdminOrManager(resource.data.clubId);
    }

    // ──────────────────────────────────────────────
    // NOTIFICATIONS
    // ──────────────────────────────────────────────
    match /notifications/{notifId} {
      // Users can only read their own notifications
      allow read: if isAuth() && resource.data.userId == uid();

      // Any authenticated club member can create (system creates on behalf)
      allow create: if isAuth();

      // Users can only update (mark as read) their own notifications
      allow update: if isAuth() && resource.data.userId == uid();

      // Users can delete their own notifications
      allow delete: if isAuth() && resource.data.userId == uid();
    }

    // ──────────────────────────────────────────────
    // APP CONFIG (global settings)
    // ──────────────────────────────────────────────
    match /config/{docId} {
      // Anyone can read (needed to check registrationOpen before login)
      allow read: if true;

      // Only editable from Firebase Console (no client writes)
      allow write: if false;
    }

    // ──────────────────────────────────────────────
    // BACKOFFICE CACHE (superadmin only)
    // ──────────────────────────────────────────────
    match /backoffice_cache/{docId} {
      allow read: if isAuth() && userDoc().isSuperAdmin == true;
      allow write: if false; // Only Cloud Functions (admin SDK) can write
    }

    // ──────────────────────────────────────────────
    // AI USAGE LOGS (superadmin backoffice only)
    // ──────────────────────────────────────────────
    match /ai_usage_logs/{logId} {
      // Only superadmins can read usage logs (for the backoffice)
      allow read: if isAuth() && userDoc().isSuperAdmin == true;

      // Client writes are blocked — only Cloud Functions (admin SDK) can write
      allow write: if false;
    }

    // ──────────────────────────────────────────────
    // DENY ALL OTHER COLLECTIONS
    // ──────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
